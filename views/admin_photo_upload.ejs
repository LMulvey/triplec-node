<% include partials/_header %>


<div class="container">
    <div class="col-sm-8 col-sm-offset-2">
        <h1>Upload an Image üñºÔ∏è</h1>

        <!-- FLASH MESSAGES -->
        <% if (message.length > 0) { %>
            <div class="alert alert-warning"><%= message %></div>
        <% } %>
        <div class="form-group">
            <form action="upload" 
            enctype="multipart/form-data" class="dropzone" id="dropper" method="post">
            
            <input class="form-control" type="file" name="images" multiple />
            </form>
        </div>
        <button id="submitAll" class="invisible form-control btn btn-success" type="submit">
            Submit!
        </button>
    </div>
</div>

<script src="/js/dropzone.js"></script>
<script>
    let galleries = <%- JSON.stringify( galleries ); %>
    function createDropdown(name) {
        let html = `<select name="galleryDropdown" class="form-control" id="${name}">`;
            galleries.forEach(gallery => {
            html += `<option value="${gallery._id}">${gallery.info.name}</option>`;
        });
        return `${html}</select>`;
    }
    
  Dropzone.options.dropper = {
        url: 'upload',
        maxFilesize: 10, // MB
        maxFiles: 10,
        autoProcessQueue: false,
        uploadMultiple: true,
        paramName: function() { return 'images' },
        method: 'post',
        parallelUploads: 10,
        init: function() {
                let submitButton = document.querySelector("#submitAll")

                submitButton.addEventListener("click", () => {
                    this.processQueue(); // Tell Dropzone to process all queued files.
                });

                // 'scope' is all files
                this.on("addedfile", function (file) {
                    var unique_field_id = new Date().getTime();
                    submitButton.style.visibility = 'visible';

                    title = file.title == undefined ? "" : file.title;
                    file._titleLabel = Dropzone.createElement("<label for='title'>Title</label>");
                    file._titleBox = Dropzone.createElement(`<input id='${file.name + unique_field_id}_title' class="form-control" type='text' name='title' value="${title}">`);
                    file.previewElement.appendChild(file._titleLabel);
                    file.previewElement.appendChild(file._titleBox);

                    description = file.description == undefined ? "" : file.description;
                    file._descriptionId = `${file.name + unique_field_id}_desc`;
                    file._descriptionLabel = Dropzone.createElement(`<label for="description">Description</label>`);
                    file._descriptionBox = Dropzone.createElement(`<input id='${file._descriptionId}' class='form-control' type='text' name='description' value='${description}'>`);
                    file.previewElement.appendChild(file._descriptionLabel);
                    file.previewElement.appendChild(file._descriptionBox);
                    
                    dropdownLabel = Dropzone.createElement(`<label for="${name}">Gallery</label>`);
                    dropdown = Dropzone.createElement(createDropdown(`${file.name}${unique_field_id}_gallery`));
                    file.previewElement.appendChild(dropdownLabel);
                    file.previewElement.appendChild(dropdown);
                    
               });

                this.on("sending", function (file, xhr, formData) {
                    title = file.previewElement.querySelector("input[name='title']");
                    description = file.previewElement.querySelector("input[name='description']");
                    dropdown = file.previewElement.querySelector("select[name='galleryDropdown']");

                    formData.append("imageTitle", title.value);
                    formData.append("imageDesc", description.value);
                    formData.append("imageGallery", dropdown.value);
                });
        }
    };
</script>
<% include partials/_footer %>
